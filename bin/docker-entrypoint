#!/bin/bash -e

# Enable jemalloc for reduced memory usage and latency.
if [ -z "${LD_PRELOAD+x}" ]; then
    LD_PRELOAD=$(find /usr/lib -name libjemalloc.so.2 -print -quit)
    export LD_PRELOAD
fi

# Cloud Run wraps the command (e.g. `sh -c ...`), so arg inspection is brittle.
# Always ensure databases are ready before starting the app. These tasks are idempotent.
echo "[entrypoint] Running db:prepare..."
./bin/rails db:prepare

echo "[entrypoint] Ensuring Solid Cable schema exists..."
# Load Solid Cable schema only if the table is missing in the cable database connection.
./bin/rails runner 'ActiveRecord::Base.connected_to(database: :cable) { exit(0) if ActiveRecord::Base.connection.data_source_exists?(:solid_cable_messages); exit(1) }' \
  || ./bin/rails db:schema:load:cable

exec "${@}"
